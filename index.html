<!DOCTYPE html>
<html>
<head>
    <title>–®–∞—É—Ä–º–∞ –ò–º–ø–µ—Ä–∏—è v1.4.1</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: linear-gradient(45deg, #ff6b35, #f7931e); 
            color: white; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh; overflow: hidden;
        }
        #header { 
            position: fixed; top: 0; left: 0; right: 0; 
            background: rgba(0,0,0,0.9); padding: 5px; text-align: center; 
            font-size: 12px; z-index: 100; height: 30px;
        }
        #reset-btn { 
            position: fixed; top: 35px; right: 10px; 
            background: #ff4444; color: white; padding: 8px 12px; 
            border-radius: 20px; cursor: pointer; font-size: 12px; z-index: 101;
        }
        #tasks-btn {
            position: fixed; top: 35px; left: 10px; 
            background: #4CAF50; color: white; border: none; padding: 8px 12px; 
            border-radius: 20px; cursor: pointer; font-size: 12px; z-index: 101;
        }
        #debug { 
            position: fixed; top: 70px; left: 10px; 
            background: rgba(0,0,0,0.8); padding: 5px 8px; 
            border-radius: 10px; font-size: 11px; max-width: 200px; z-index: 101;
        }
        #tasks {
            position: fixed; top: 110px; right: 10px; 
            background: rgba(0,0,0,0.95); padding: 15px; border-radius: 15px; 
            max-width: 250px; display: none; z-index: 102; font-size: 14px;
        }
        #game { 
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
            height: 100vh; padding-top: 120px; padding-bottom: 120px;
        }
        #shaurma { 
            font-size: 80px; cursor: pointer; 
            transition: all 0.1s; user-select: none;
            margin-bottom: 20px;
        }
        #shaurma:active { transform: scale(0.9); }
        #stats { text-align: center; font-size: 24px; margin: 10px 0; }
        #upgrades { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: rgba(0,0,0,0.95); padding: 20px; 
            max-height: 35vh; overflow-y: auto;
        }
        .upgrade { 
            background: rgba(255,255,255,0.15); 
            margin: 8px 0; padding: 15px; 
            border-radius: 12px; cursor: pointer; 
            font-size: 16px; transition: all 0.2s;
            touch-action: manipulation;
        }
        .upgrade.ready { 
            background: rgba(255,215,0,0.4); 
            border: 2px solid #ffd700;
            animation: pulse 1s infinite; 
        }
        .upgrade.bought { background: rgba(0,255,0,0.3); border: 2px solid #00ff00; }
        .version { color: #ffd700; font-weight: bold; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body>
    <div id="header">
        <span class="version">v1.4.1</span> | 
        <span id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
    </div>
    <button id="tasks-btn">üìã –ó–∞–¥–∞–Ω–∏—è</button>
    <button id="reset-btn">üîÑ –°–±—Ä–æ—Å</button>
    <div id="debug">–ì–æ—Ç–æ–≤–æ</div>
    <div id="tasks">
        <h4>üìã –ó–∞–¥–∞–Ω–∏—è –¥–Ω—è</h4>
        <div id="task-list"></div>
    </div>
    
    <div id="game">
        <div id="shaurma">üßÜ</div>
        <div id="stats">
            <div id="count">0 üßÜ</div>
            <div id="dps">0/—Å–µ–∫</div>
            <div id="tap-power">–¢–∞–ø: x1</div>
        </div>
    </div>
    
    <div id="upgrades">
        <h3>üè™ –ê–ø–≥—Ä–µ–π–¥—ã</h3>
        <div id="tap-upgrade" class="upgrade">üëê –ë—ã—Å—Ç—Ä—ã–µ —Ä—É–∫–∏<br>–£—Ä. <span id="tap-level">0</span><br><span id="tap-cost">50</span> üßÜ</div>
        <div id="helper-upgrade" class="upgrade">ü§ñ –ü–æ–º–æ—â–Ω–∏–∫<br>–£—Ä. <span id="helper-level">0</span><br><span id="helper-cost">200</span> üßÜ</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();
        
        const userId = tg.initDataUnsafe?.user?.id?.toString() || 'guest_' + Math.random().toString(36).slice(2);
        
        let game = {
            version: '1.4.1',
            shaurma: 0,
            dps: 0,
            tapPower: 1,
            tapLevel: 0,
            helperLevel: 0,
            tapCost: 50,
            helperCost: 200
        };

        const el = {
            shaurma: document.getElementById('shaurma'),
            count: document.getElementById('count'),
            dps: document.getElementById('dps'),
            tapPower: document.getElementById('tap-power'),
            tapLevel: document.getElementById('tap-level'),
            helperLevel: document.getElementById('helper-level'),
            tapCost: document.getElementById('tap-cost'),
            helperCost: document.getElementById('helper-cost'),
            tapUpgrade: document.getElementById('tap-upgrade'),
            helperUpgrade: document.getElementById('helper-upgrade'),
            status: document.getElementById('status'),
            debug: document.getElementById('debug'),
            reset: document.getElementById('reset-btn'),
            tasksBtn: document.getElementById('tasks-btn'),
            tasks: document.getElementById('tasks')
        };

        function load() {
            const saved = localStorage.getItem('shaurma_v1.4');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (data.version === '1.4.1') {
                        game = data;
                        el.status.textContent = '–ó–∞–≥—Ä—É–∂–µ–Ω–æ';
                        return;
                    }
                } catch(e) {}
            }
            el.status.textContent = '–ù–æ–≤–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ';
        }

        function reset() {
            localStorage.removeItem('shaurma_v1.4');
            game = {
                version: '1.4.1',
                shaurma: 0,
                dps: 0,
                tapPower: 1,
                tapLevel: 0,
                helperLevel: 0,
                tapCost: 50,
                helperCost: 200
            };
            update();
            el.status.textContent = '–°–±—Ä–æ—à–µ–Ω–æ';
        }

        async function update() {
            el.count.textContent = Math.floor(game.shaurma) + ' üßÜ';
            el.dps.textContent = game.dps + '/—Å–µ–∫';
            el.tapPower.textContent = '–¢–∞–ø: x' + game.tapPower;
            el.tapLevel.textContent = game.tapLevel;
            el.helperLevel.textContent = game.helperLevel;
            el.tapCost.textContent = game.tapCost;
            el.helperCost.textContent = game.helperCost;

            el.tapUpgrade.className = game.shaurma >= game.tapCost ? 'upgrade ready' : 'upgrade';
            el.helperUpgrade.className = game.shaurma >= game.helperCost ? 'upgrade ready' : 'upgrade';

            try {
                await fetch('/api/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(game)
                });
                el.debug.textContent = '‚òÅÔ∏è –û–±–ª–∞–∫–æ';
            } catch(e) {
                el.debug.textContent = '–õ–æ–∫–∞–ª—å–Ω–æ';
            }
            
            localStorage.setItem('shaurma_v1.4', JSON.stringify(game));
        }

        el.shaurma.onclick = () => {
            game.shaurma += game.tapPower;
            update();
            tg.HapticFeedback.impactOccurred('light');
            el.shaurma.style.transform = 'scale(0.9)';
            setTimeout(() => el.shaurma.style.transform = '', 100);
        };

        setInterval(() => {
            game.shaurma += game.dps;
            update();
        }, 1000);

        el.tapUpgrade.onclick = () => {
            if (game.shaurma >= game.tapCost) {
                game.shaurma -= game.tapCost;
                game.tapLevel++;
                game.tapPower++;
                game.tapCost = Math.floor(game.tapCost * 1.15);
                update();
                tg.HapticFeedback.notificationOccurred('success');
            }
        };

        el.helperUpgrade.onclick = () => {
            if (game.shaurma >= game.helperCost) {
                game.shaurma -= game.helperCost;
                game.helperLevel++;
                game.dps++;
                game.helperCost = Math.floor(game.helperCost * 1.2);
                update();
                tg.HapticFeedback.notificationOccurred('success');
            }
        };

        el.reset.onclick = reset;
        el.tasksBtn.onclick = () => el.tasks.style.display = el.tasks.style.display === 'block' ? 'none' : 'block';

        load();
        update();
    </script>
</body>
</html>
