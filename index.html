<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–®–∞—É—Ä–º–∞ –ò–º–ø–µ—Ä–∏—è</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    /* ========================= */
    /* GLOBAL RESET & BASE STYLE */
    /* ========================= */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      height: 100dvh;
      width: 100%;
      background: linear-gradient(45deg, #ff6b35, #f7931e);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: white;
      overflow: hidden;
      overscroll-behavior: contain;
      touch-action: manipulation;
    }

    .hidden { display: none; }

    /* ========================= */
    /* BUTTONS */
    /* ========================= */
    .btn {
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 12px;
      border: none;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }
    .btn:hover { opacity: 0.9; }

    /* ========================= */
    /* UPGRADE CARDS */
    /* ========================= */
    .upgrade {
      background: rgba(255, 255, 255, 0.1);
      padding: 12px;
      margin-top: 10px;
      border-radius: 12px;
      cursor: not-allowed;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    .upgrade.ready {
      background: rgba(76, 175, 80, 0.3);
      cursor: pointer;
    }
    .upgrade.ready:hover {
      background: rgba(76, 175, 80, 0.5);
    }

    /* ========================= */
    /* TASK PANEL */
    /* ========================= */
    #tasks-panel {
      position: fixed;
      top: 110px;
      right: 10px;
      background: rgba(0, 0, 0, 0.95);
      padding: 15px;
      border-radius: 15px;
      max-width: 260px;
      z-index: 102;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }
  </style>
</head>

<body>
  <!-- ========================= -->
  <!-- HEADER: VERSION + STATUS -->
  <!-- ========================= -->
  <header id="header" style="
    position: fixed; top: 0; left: 0; right: 0;
    height: 30px;
    background: rgba(0,0,0,0.9);
    text-align: center;
    font-size: 12px;
    line-height: 30px;
    z-index: 100;
  ">
    <span style="color:#ffd700;">v1.5</span> |
    <span id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
  </header>

  <!-- ========================= -->
  <!-- DEBUG & CONTROL BUTTONS -->
  <!-- ========================= -->
  <div style="position: fixed; top: 35px; left: 10px; z-index:101;">
    <button id="tasks-btn" class="btn" style="background:#4CAF50;">üìã –ó–∞–¥–∞–Ω–∏—è</button>
  </div>
  <div style="position: fixed; top: 35px; right: 10px; z-index:101;">
    <button id="reset-btn" class="btn" style="background:#ff4444;">üîÑ –°–±—Ä–æ—Å</button>
  </div>
  <div id="debug" style="
    position: fixed; top: 70px; left: 10px;
    background: rgba(0,0,0,0.8);
    padding: 6px 10px;
    border-radius: 12px;
    font-size: 11px;
    z-index:101;
  ">...</div>

  <!-- ========================= -->
  <!-- MAIN TAP SCENE -->
  <!-- ========================= -->
  <main id="tap-scene" style="
    height: 100dvh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding-top: 120px;
    padding-bottom: 140px;
    position: relative;
  ">
    <!-- KIOSK (TAPPABLE OBJECT) -->
    <div id="kiosk-container" style="
      position: relative;
      width: 200px;
      height: 200px;
      cursor: pointer;
      user-select: none;
    ">
      <img id="kiosk-base" src="https://i.postimg.cc/qtRjvcWY/kiosk-sma.png"
           alt="–ö–∏–æ—Å–∫" style="width:100%; height:100%; object-fit:contain;" />
    </div>

    <!-- STATS -->
    <div id="stats" style="
      text-align: center;
      margin-top: 20px;
      font-size: 22px;
      line-height: 1.5;
    ">
      <div id="count">0 üßÜ</div>
      <div id="dps">0 / —Å–µ–∫</div>
      <div id="tap-power">–¢–∞–ø: x1</div>
    </div>

    <!-- FLOATING NUMBERS -->
    <div id="tap-float-container" style="
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      pointer-events: none;
      width: 100%;
      height: 100%;
    "></div>
  </main>

  <!-- ========================= -->
  <!-- TASKS PANEL (HIDDEN BY DEFAULT) -->
  <!-- ========================= -->
  <section id="tasks-panel" class="hidden"></section>

  <!-- ========================= -->
  <!-- UPGRADES PANEL (BOTTOM) -->
  <!-- ========================= -->
  <section id="upgrades" style="
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.95);
    padding: 20px;
    max-height: 35vh;
    overflow-y: auto;
    z-index: 99;
  ">
    <h3 style="margin-bottom: 12px;">üè™ –ê–ø–≥—Ä–µ–π–¥—ã</h3>

    <div id="tap-upgrade" class="upgrade">
      üëê –ë—ã—Å—Ç—Ä—ã–µ —Ä—É–∫–∏<br>
      –£—Ä. <span id="tap-level">0</span><br>
      <span id="tap-cost">50</span> üßÜ
    </div>

    <div id="helper-upgrade" class="upgrade">
      ü§ñ –ü–æ–º–æ—â–Ω–∏–∫<br>
      –£—Ä. <span id="helper-level">0</span><br>
      <span id="helper-cost">200</span> üßÜ
    </div>
  </section>

  <!-- ========================= -->
  <!-- GAME LOGIC -->
  <!-- ========================= -->
  <script>
    // ==========================
    // INIT TELEGRAM WEB APP
    // ==========================
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.MainButton.hide();

    // ==========================
    // GAME STATE
    // ==========================
    const userId = tg.initDataUnsafe?.user?.id?.toString() || 'guest_' + Math.random().toString(36).slice(2, 8);

    let game = {
      version: '1.5',
      shaurma: 0,
      dps: 0,
      tapPower: 1,
      tapLevel: 0,
      helperLevel: 0,
      tapCost: 50,
      helperCost: 200,
      tapsCount: 0,
      tasksDone: [false, false, false],
      unlockedTruck: false
    };

    // ==========================
    // DOM ELEMENTS
    // ==========================
    const el = {
      kioskContainer: document.getElementById('kiosk-container'),
      kioskBase: document.getElementById('kiosk-base'),
      count: document.getElementById('count'),
      dps: document.getElementById('dps'),
      tapPower: document.getElementById('tap-power'),
      tapLevel: document.getElementById('tap-level'),
      helperLevel: document.getElementById('helper-level'),
      tapCost: document.getElementById('tap-cost'),
      helperCost: document.getElementById('helper-cost'),
      tapFloat: document.getElementById('tap-float-container'),
      reset: document.getElementById('reset-btn'),
      tasksBtn: document.getElementById('tasks-btn'),
      tasksPanel: document.getElementById('tasks-panel'),
      status: document.getElementById('status'),
      debug: document.getElementById('debug'),
      tapUpgrade: document.getElementById('tap-upgrade'),
      helperUpgrade: document.getElementById('helper-upgrade')
    };

    // ==========================
    // KIOSK LEVELS
    // ==========================
    const kioskLevels = [
      { minLevel: 0, src: 'https://i.postimg.cc/qtRjvcWY/kiosk-sma.png' },
      { minLevel: 5, src: 'https://i.postimg.cc/DWZBwQRM/kiosk-med.png' },
      { minLevel: 10, src: 'https://i.postimg.cc/VJ4KwZZ2/kiosk-big.png' }
    ];

    function updateKioskImage() {
      let current = kioskLevels[0].src;
      for (let i = 0; i < kioskLevels.length; i++) {
        if (game.tapLevel >= kioskLevels[i].minLevel) {
          current = kioskLevels[i].src;
        }
      }
      if (el.kioskBase.src !== current) {
        el.kioskBase.style.opacity = '0.6';
        el.kioskBase.src = current;
        setTimeout(() => el.kioskBase.style.opacity = '1', 100);
      }
    }

    // ==========================
    // TASKS
    // ==========================
    const tasks = [
      { id: 0, name: '50 —Ç–∞–ø–æ–≤', progress: () => game.tapsCount, goal: 50, reward: 100, claimed: false },
      { id: 1, name: '1 –∞–ø–≥—Ä–µ–π–¥', progress: () => game.tapLevel + game.helperLevel, goal: 1, reward: 250, claimed: false },
      { id: 2, name: '200 —à–∞—É—Ä–º—ã', progress: () => Math.floor(game.shaurma), goal: 200, reward: 500, claimed: false }
    ];

    function renderTasks() {
      el.tasksPanel.innerHTML = '<h4>üìã –ó–∞–¥–∞–Ω–∏—è</h4><div id="task-list"></div>';
      const taskList = el.tasksPanel.querySelector('#task-list');
      tasks.forEach((task, i) => {
        const progress = task.progress();
        const done = progress >= task.goal && !task.claimed;
        const div = document.createElement('div');
        div.style.margin = '8px 0';
        div.style.padding = '12px';
        div.style.borderRadius = '8px';
        div.style.cursor = done ? 'pointer' : 'default';
        div.style.background = done
          ? 'rgba(76,175,80,0.4)'
          : task.claimed
            ? 'rgba(0,255,0,0.2)'
            : 'rgba(255,255,255,0.1)';
        div.innerHTML = `
          <div style="font-weight:bold;font-size:14px;">${task.claimed ? 'üéÅ' : done ? '‚úÖ' : 'üîÑ'} ${task.name}</div>
          <div style="font-size:12px; opacity:0.9; margin-top:4px;">
            ${progress}/${task.goal} ‚Üí <span style="color:#ffd700;">${task.reward}</span> üßÜ
          </div>
        `;
        div.onclick = () => {
          if (done) {
            game.shaurma += task.reward;
            task.claimed = true;
            game.tasksDone[i] = true;
            update();
            renderTasks();
            tg.HapticFeedback.notificationOccurred('success');
          }
        };
        taskList.appendChild(div);
      });
    }

    // ==========================
    // LOAD / SAVE
    // ==========================
    function load() {
      const saved = localStorage.getItem('shaurma_v1.5');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          Object.assign(game, data);
          tasks.forEach((t, i) => t.claimed = game.tasksDone[i] || false);
          el.status.textContent = '–ó–∞–≥—Ä—É–∂–µ–Ω–æ';
          return;
        } catch (e) {}
      }
      el.status.textContent = '–ù–æ–≤–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ';
    }

    async function save() {
      localStorage.setItem('shaurma_v1.5', JSON.stringify(game));
      try {
        // –í –±—É–¥—É—â–µ–º: –æ—Ç–ø—Ä–∞–≤–∏–º initData –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        await fetch('/api/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, ...game })
        });
        el.debug.textContent = '‚òÅÔ∏è v1.5';
      } catch (e) {
        el.debug.textContent = '–õ–æ–∫–∞–ª—å–Ω–æ';
      }
    }

    // ==========================
    // RESET
    // ==========================
    function reset() {
      if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å?')) return;
      localStorage.removeItem('shaurma_v1.5');
      game = {
        version: '1.5',
        shaurma: 0,
        dps: 0,
        tapPower: 1,
        tapLevel: 0,
        helperLevel: 0,
        tapCost: 50,
        helperCost: 200,
        tapsCount: 0,
        tasksDone: [false, false, false],
        unlockedTruck: false
      };
      tasks.forEach(t => t.claimed = false);
      update();
      el.status.textContent = '–°–±—Ä–æ—à–µ–Ω–æ';
    }

    // ==========================
    // UPDATE UI
    // ==========================
    function update() {
      el.count.textContent = Math.floor(game.shaurma) + ' üßÜ';
      el.dps.textContent = game.dps + ' / —Å–µ–∫';
      el.tapPower.textContent = '–¢–∞–ø: x' + game.tapPower;
      el.tapLevel.textContent = game.tapLevel;
      el.helperLevel.textContent = game.helperLevel;
      el.tapCost.textContent = game.tapCost;
      el.helperCost.textContent = game.helperCost;

      el.tapUpgrade.className = game.shaurma >= game.tapCost ? 'upgrade ready' : 'upgrade';
      el.helperUpgrade.className = game.shaurma >= game.helperCost ? 'upgrade ready' : 'upgrade';

      updateKioskImage();
      save();
    }

    // ==========================
    // PASSIVE INCOME
    // ==========================
    setInterval(() => {
      game.shaurma += game.dps;
      update();
    }, 1000);

    // ==========================
    // TAP HANDLER (CLICK ON KIOSK)
    // ==========================
    el.kioskContainer.onclick = () => {
      const tapPower = game.tapPower || 1;
      game.shaurma += tapPower;
      game.tapsCount++;

      // Animation
      el.kioskContainer.style.transform = 'scale(0.95)';
      setTimeout(() => el.kioskContainer.style.transform = '', 100);

      // Floating number
      const floatEl = document.createElement('div');
      floatEl.textContent = `+${tapPower} üßÜ`;
      floatEl.style.cssText = `
        position: absolute;
        left: 50%;
        bottom: 50px;
        transform: translateX(-50%);
        color: #ffd700;
        font-weight: bold;
        font-size: 18px;
        opacity: 1;
        transition: all 1s ease-out;
        pointer-events: none;
      `;
      el.tapFloat.appendChild(floatEl);
      setTimeout(() => {
        floatEl.style.bottom = '100px';
        floatEl.style.opacity = '0';
      }, 50);
      setTimeout(() => floatEl.remove(), 1050);

      tg.HapticFeedback.impactOccurred('light');
      update();
    };

    // ==========================
    // UPGRADES
    // ==========================
    el.tapUpgrade.onclick = () => {
      if (game.shaurma >= game.tapCost) {
        game.shaurma -= game.tapCost;
        game.tapLevel++;
        game.tapPower++;
        game.tapCost = Math.floor(game.tapCost * 1.15);
        update();
        tg.HapticFeedback.notificationOccurred('success');
      }
    };

    el.helperUpgrade.onclick = () => {
      if (game.shaurma >= game.helperCost) {
        game.shaurma -= game.helperCost;
        game.helperLevel++;
        game.dps++;
        game.helperCost = Math.floor(game.helperCost * 1.2);
        update();
        tg.HapticFeedback.notificationOccurred('success');
      }
    };

    // ==========================
    // BUTTONS
    // ==========================
    el.reset.onclick = reset;
    el.tasksBtn.onclick = () => {
      if (el.tasksPanel.style.display === 'block') {
        el.tasksPanel.style.display = 'none';
      } else {
        el.tasksPanel.style.display = 'block';
        renderTasks();
      }
    };

    // ==========================
    // START GAME
    // ==========================
    load();
    update();
  </script>
</body>
</html>
